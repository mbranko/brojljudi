<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.4/css/ol.css" type="text/css">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .map {
        height: 100%;
        width: 100%;
      }
      #calcPane {
        width: 300px;
        position: fixed;
        top: 15px;
        right: 15px;
        background-color: #FFFFFF;
        z-index: 2;
        font-family: sans-serif;
        font-size: 10pt;
      }
      .polytable {
        padding: 2px;
      }
      .polyname {
        width: 50px;
        text-align: left;
      }
      .polyarea {
        width: 100px;
        text-align: right;
      }
      .polydensity {
        width: 100px;
        text-align: left;
      }
      .polynumber {
        width: 50px;
        text-align: right;
      }      
    </style>
    <script src="https://openlayers.org/en/v4.6.4/build/ol.js" type="text/javascript"></script>
    <title>Procena broja ljudi</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div id="calcPane">
      <table id="polytable">
        <thead>
          <tr>
            <th class="polyname">P#</th>
            <th class="polyarea">Povr≈°ina m<sup>2</sup></th>
            <th class="polydensity">Gustina</th>
            <th class="polynumber">Broj</th>
          </tr>
        </thead>
        <tbody/>
        <tfoot>
          <tr></tr>
        </tfoot>
      </table>
    </div>    
    <script type="text/javascript">
      var colors = ['#000000', '#FF0000', '#800000', '#FFFF00', '#808000', 
                    '#00FF00', '#008000', '#00FFFF', '#008080', '#0000FF', 
                    '#FF00FF', '#800080'];
      var allPolygons = [];

      function getDensityName(value) {
        switch(value) {
          case 1:
            return 'mala';
          case 2:
            return 'srednja';
          case 3:
            return 'velika';
        }
      }

      function getArea(polygon) {
        var area = ol.Sphere.getArea(polygon.getGeometry());
        var sqm = Math.round(area);
        return sqm;
        //return Math.round(google.maps.geometry.spherical.computeArea(polygon.getPath()));
      }

      function getCrowdSize(polygon) {
        switch (polygon.density) {
          case 1:
            return Math.round(getArea(polygon) * 0.5);
          case 2:
            return Math.round(getArea(polygon) * 2);
          case 3:
            return Math.round(getArea(polygon) * 4);
          default:
            return Math.round(getArea(polygon) * 0.5);
        }
      }

      function createPanelItem(polygon, row) {
        var html = '<tr>';
        html += '<td><span style="color: ' + polygon.color + '; font-weight: bold">P' + (polygon.index+1) + '</span></td>';
        html += '<td class="polyarea">' + getArea(polygon) + '</td>';
        html += '<td><select id="combo' + polygon.index + '"><option value="1">mala</option><option value="2">srednja</option><option value="3">velika</option></select></td>';
        html += '<td class="polynumber">' + getCrowdSize(polygon) + '</td>';
        html += '</tr>';
        row.innerHTML = html;          
        var combo = document.getElementById('combo' + polygon.index);
        combo.value = '' + polygon.density;
        combo.addEventListener('change', function() {
          polygon.density = parseInt(combo.value);
          updatePanel();
        });
      }

      function updatePanelItem(polygon, row) {
        createPanelItem(polygon, row);
      }

      function addPanelItem(polygon, tbody) {
        var row = document.createElement("tr");
        tbody.appendChild(row);
        createPanelItem(polygon, row);
      }

      function updatePanel() {
        var tBody = document.getElementById('polytable').getElementsByTagName('tbody')[0];
        var rows = tBody.getElementsByTagName('tr');
        var totalPeople = 0;
        for (var i = 0; i < allPolygons.length; i++) {
          totalPeople += getCrowdSize(allPolygons[i]);
          if (i < rows.length) {
            updatePanelItem(allPolygons[i], rows[i]);
          } else {
            addPanelItem(allPolygons[i], tBody);
          }
        }
        var footerRow = document.getElementById('polytable').getElementsByTagName('tfoot')[0].getElementsByTagName('tr')[0];
        footerRow.innerHTML = '<td colspan="3"><b>UKUPNO</b></td><td class="polynumber"><b>' + totalPeople + '</b></td>';
      }

      var raster = new ol.layer.Tile({
        source: new ol.source.OSM()
      });
      var source = new ol.source.Vector({wrapX: false});
      var vector = new ol.layer.Vector({
        source: source
      });
      var sketch; // currently drawn feature

      var map = new ol.Map({
        target: 'map',
        layers: [raster, vector],
        view: new ol.View({
          center: ol.proj.fromLonLat([19.8444378, 45.255125]),
          zoom: 18
        })
      });
      var modify = new ol.interaction.Modify({source: source});
      modify.on('modifyend', function(event) {
        updatePanel();
      });
      map.addInteraction(modify);
      var draw, snap;

      function addInteractions() {
        draw = new ol.interaction.Draw({
          source: source,
          type: 'Polygon'
        });
        map.addInteraction(draw);
        snap = new ol.interaction.Snap({source: source});
        map.addInteraction(snap);
        draw.on('drawend', function(event) {
          var polygon = event.feature;
          var colorIndex = allPolygons.length % colors.length;
          polygon.index = allPolygons.length;
          polygon.density = 1;
          polygon.color = colors[colorIndex];
          var fillColor = ol.color.asArray(polygon.color);
          fillColor = fillColor.slice();
          fillColor[3] = 0.2;
          polygon.setStyle(new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: polygon.color}),
            fill: new ol.style.Fill({
              color: fillColor})
            }
          ));
          allPolygons.push(polygon);
          updatePanel();
        });
      }
      addInteractions();
    </script>
  </body>
</html>